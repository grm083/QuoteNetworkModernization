/*
Use of Class : This class will be ue as Service class for CPQ Quote Line Object
 
Generally Service class should call to Query Selector class 
*/
public with sharing class QuoteLineServices {
   
    // Constants: related to Quoteline Only
 
    //SDT 30079
    public static final string MAX_EVERYDAY_SCHEDULE = 'Please provide a value between 1 to {0} days';
    //SDT 31262
    public static final string MAX_EVERYWEEK_SCHEDULE = 'Please provide a value between 1 to {0} Weeks';
    public static final string SERVICE_DAYS_ERROR = 'Please provide a Service Days to proceed';
    public static final string SCHEDULE_FREQUENCY_WEEKLY = 'Weekly';
    //TCS-pkulkarn-SDT-38495-20-May-2024-Added following lines
    public static final string SCHEDULE_FREQUENCY_MONTHLY = 'Monthly';
    public static final string MAX_EVERYMONTH_SCHEDULE = 'Please provide a value between 1 to {0} Month(s) for Every __ Month(s)';
    //TCS-pkulkarn-SDT-38495-20-May-2024-End
    public static final string SCHEDULE_FREQUENCY_DAILY = 'Daily';

    public static final string DEFAULT_EXCEPTION_REASON = 'SERCHG';
    public static final string VCR_CODE_NBT = 'NBT';
    public static final string VCR_CODE_NBG = 'NBG';
    public static final string ASSET_EQUIP_FIELD = 'Equipment_Owner__c';
    public static final string DEFAULT_MAS_BOX = 'CENTRAL';
    public static final string COMPACTOR_CODE = 'CMP';
    public static final string UPDATE_ASSET_RECORD_TYPE = 'Update_Asset_Case';
    public static final string PRODUCTFAMILY_WASTECATEGORY = 'Waste Category';
    public static final string PRODUCTFAMILY_WASTESTREAM = 'Waste Stream';
    public static final string ASSET_WO_COMPONENT_CANCELLATION = 'Cancelllation';
    //defaults for quote Lines
     static final String ExceptionType = 'CLTINITCHG';
     static final String ExceptionReason = 'SERCHG';
     static final String ExceptionComment = 'This spec was generated by Salesforce Quote Number: {0}';
     //SDT-31110 - To disable copy of fields from bundle to inserted record.
     public static Boolean DISABLE_QL_COPY_FROM_BUNDLE_ONINSERT= false;
 
     //SDT-32753
     public static String STATUS_PRODUCT_CONFIGURED = 'Product Configured';
	
 
    /* Method is used to create and return Parent quote line Object */
    public static SBQQ__QuoteLine__c returnParentQuoteline(Id QuoteId,Id productId,String equipmentSize,String occurrenceType,Boolean bundle,Decimal Quantity,Decimal quoteLineNumber) {
    
            SBQQ__QuoteLine__c parentQuoteLineObject = new SBQQ__QuoteLine__c(SBQQ__Quote__c = quoteId,
                                                                 SBQQ__Product__c = productId,
                                                                 Equipment_Size__c = equipmentSize,
                                                                 Occurrence_Type__c = occurrenceType,
                                                                 SBQQ__Bundle__c = bundle,
                                                                 SBQQ__Quantity__c = Quantity,
                                                                 SBQQ__Number__c = quoteLineNumber);
         return parentQuoteLineObject;
     }
 
     //Get Quote Lines by Parent Id
     public static List<SBQQ__QuoteLine__c> getQuoteLinesByParentId(Id parentId)
     {
        return [SELECT Id, SBQQ__StartDate__c, SBQQ__EndDate__c, SBQQ__Quantity__c, Description_of_Waste__c,MaterialGrade__c,
       SBQQ__ProductName__c,SBQQ__ProductFamily__c, SBQQ__ProductOption__r.SBQQ__Type__c, SBQQ__Product__c, Equipment_Size__c, SBQQ__Quote__c,
       SBQQ__RequiredBy__c,Duration__c, SID__c, SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.RecordType.DeveloperName
       FROM SBQQ__QuoteLine__c
       WHERE Id =: parentId OR
       SBQQ__RequiredBy__c =: parentId OR
       SBQQ__RequiredBy__r.SBQQ__RequiredBy__c =: parentId];
     }
 
     //Get Quote Lines by Parent Id
     public static List<SBQQ__QuoteLine__c> getQuoteLinesForPosition(Id parentId)
     {
       return [SELECT Id, Location_Position_Name__c, LocationPositionName__c, SetupComment__c
       FROM SBQQ__QuoteLine__c
       WHERE Id =: parentId OR SBQQ__RequiredBy__c =: parentId OR
       SBQQ__RequiredBy__r.SBQQ__RequiredBy__c =: parentId];
     }
 
      //Get Quote Lines by QuoteLine Ids
      public static List<SBQQ__QuoteLine__c> getQuoteLinesByIds(Set<Id> QLIds)
      {
        //Haul Away SDT 42652 44574
         return [SELECT Id, SBQQ__StartDate__c, SBQQ__EndDate__c, SBQQ__Quantity__c, Description_of_Waste__c,MaterialGrade__c,
        SBQQ__ProductName__c,SBQQ__ProductFamily__c, SBQQ__ProductOption__r.SBQQ__Type__c, SBQQ__Product__c, Equipment_Size__c, SBQQ__Quote__c,
        SBQQ__RequiredBy__c,Duration__c, SID__c,SBQQ__Bundle__c,SBQQ__Product__r.Family,IsExtrapickup__c,Occurrence_Type__c
        ,SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.Haul_Away_Vendor__c,SBQQ__Quote__r.SBQQ__ShippingCountry__c
        FROM SBQQ__QuoteLine__c
        WHERE Id IN: QLIds];
      }
     
     //Get Quote Lines by Parent Id
     public static List<SBQQ__QuoteLine__c> getQuoteLinesByQuoteId(Id QuoteId)
     {
       return [Select id,SBQQ__ProductFamily__c,SBQQ__Product__r.Family,SBQQ__Bundle__c,SBQQ__RequiredBy__c from SBQQ__QuoteLine__c where 
         SBQQ__Quote__c  = :quoteId];
     }
     
  
     
    /*
     * @vendor			 TCS
     * @story		   	 SDT-26174
     * @author			 Digdershika Ojha
     * @description       This method is used to return quote Bundles. Get Quote Lines by Parent Id 
     * @param             set of quoteIds the Id of Quote
     * @return            List of type SBQQ__QuoteLine__c
     */    
     public static List<SBQQ__QuoteLine__c> getQuoteLinesByQuoteIdList(Set<Id> quoteIds)
     {
          return [SELECT Id, SBQQ__ProductCode__c, SBQQ__ProductName__c, Equipment_Size__c, SBQQ__Quote__c, SBQQ__Quote__r.Name, Name, Duration__c,MaterialGrade__c, 
                 Vendor__c, Vendor__r.Name,  Material_Type__c,SBQQ__Product__r.Name,SBQQ__RequiredBy__c,SBQQ__ProductFamily__c,Occurrence_Type__c,
                 SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.RecordType.Name,Account__r.ParentId,Vendor__r.Parent_Vendor_ID__c,
                 SBQQ__ListPrice__c,SBQQ__UnitCost__c,SBQQ__Product__r.ProductCode,SBQQ__RequiredBy__r.SBQQ__RequiredBy__c,sCode__c,
                 SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.Case_Sub_Type__c,Pricing_Request__r.Market_Area_Code__c,SBQQ__Quote__r.Priority__c	
                 FROM SBQQ__QuoteLine__c 
                 WHERE SBQQ__Quote__c IN :quoteIds];
     }
   
      /* SDT-33285 update  */
     public static integer returnAssetDays(boolean addition) 
     {
         return (addition?1:0);
     }
     public static integer returnQuotelineDays(List<String> ListofString,String matchString) 
     {
        if(ListofString.Contains(matchString))
                        return 1;
        else return 0;
     }
     
    /* SDT-33285 Start */
    public static String callScenarios(SBQQ__QuoteLine__c quoteLineRecord,Asset asset) { 
     
        String FinalReturn;
        String assetReturn;
        String quoteLineReturn;
        
        Integer assetWeekday =0;
        Integer assetWeekend =0;
        Integer quoteLineWeekday =0;
        Integer quoteLineWeekend =0;
            
        List<String> quoteOccurrenceList = new List<String> ();
        List<String> assetOccurrenceList = new List<String>();
        List<String> serviceDayList = new List<String>(); 
        
        if(null != quoteLineRecord.Service_Days__c)
            serviceDayList = quoteLineRecord.Service_Days__c.split(';');
        
        System.debug('quoteLineRecord.>>>'+quoteLineRecord);
        System.debug('asset.>>>'+asset);
        
        if(null !=  quoteLineRecord.Occurrence_Type__c  && null != asset.Occurrence_Type__c ) {
            quoteOccurrenceList = quoteLineRecord.Occurrence_Type__c.split(';');
            assetOccurrenceList = asset.Occurrence_Type__c.split(';');
        }
        
        boolean changeInSize = changeInSize(quoteLineRecord,asset);         
        
        //Added for Multiple_changes Scenarios End            
        if(changeInSize || asset.Quantity__c != quoteLineRecord.SBQQ__Quantity__c) {
            FinalReturn = 'Multiple_changes';
            return FinalReturn;
        } 
        
        //Added for Occurrence_changes Scenarios End  
        else if((assetOccurrenceList.Contains('Scheduled') && quoteOccurrenceList.Contains('OC')) ||
                (assetOccurrenceList.Contains('On-Call') && quoteOccurrenceList.Contains('SCH')))
        {
            FinalReturn = 'Occurrence_change';
            return FinalReturn;
        }
         
        //Added for Weekday, Weekend and Blank Scenarios Start
        if((asset.Monday__c || asset.Tuesday__c || asset.Wednesday__c || asset.Thursday__c || asset.Friday__c ) && (asset.Saturday__c == false && asset.Sunday__c == false)){
            
            assetReturn = 'Weekday';    
                
           // assetWeekday = returnAssetDays(asset.Monday__c) +returnAssetDays(asset.Tuesday__c) + returnAssetDays(asset.Wednesday__c) + returnAssetDays(asset.Thursday__c) + returnAssetDays(asset.Friday__c);   
        }  
        else if(asset.Saturday__c || asset.Sunday__c)
        {
            assetReturn = 'Weekend'; 
           // assetWeekend = returnAssetDays(asset.Saturday__c) +returnAssetDays(asset.Sunday__c) ;
        }       
        else if(asset.Monday__c == false && asset.Tuesday__c == false && asset.Wednesday__c == false && asset.Thursday__c == false && asset.Friday__c == false && asset.Saturday__c == false && asset.Sunday__c == false)
        {
            assetReturn = 'Blank'; 
        }
        
        if((serviceDayList.Contains('M') || serviceDayList.Contains('T') || serviceDayList.Contains('W') || serviceDayList.Contains('T1') || serviceDayList.Contains('F')) && (serviceDayList.Contains('S1') == false && serviceDayList.Contains('S') == false) ) 
        {
            quoteLineReturn = 'Weekday';
           // quoteLineWeekday = returnQuotelineDays(serviceDayList,'M') + returnQuotelineDays(serviceDayList,'T') +returnQuotelineDays(serviceDayList,'W') +returnQuotelineDays(serviceDayList,'T1')+returnQuotelineDays(serviceDayList,'F');
        }
        else if(serviceDayList.Contains('S') || serviceDayList.Contains('S1'))
        {
            quoteLineReturn = 'Weekend'; 
           // quoteLineWeekend = returnQuotelineDays(serviceDayList,'S') + returnQuotelineDays(serviceDayList,'S1');
        }
        else if(serviceDayList.Contains('') || serviceDayList.Size() == 0)
        {
            quoteLineReturn = 'Blank';
        }
        
        System.debug('assetWeekend >>>'+assetWeekend );
        System.debug('assetWeekend >>>'+quoteLineWeekend );
        //if(assetWeekend != quoteLineWeekend || quoteLineWeekday != assetWeekday)
       // if(assetWeekend != quoteLineWeekend)    
      //      FinalReturn = 'Day_Change';
      //  else 
        FinalReturn = assetReturn+'_to_'+quoteLineReturn;
        
        return FinalReturn;
        
    }
    /* SDT-33285 End */
    
   /* SDT-33285 for checking frequency Change */
   public static boolean frequencyChange(SBQQ__QuoteLine__c quoteLineRecord,Asset asset) { 
        boolean frequencyChange = false;
         
        
        if(asset.Weekly_Frequency__c != null && quoteLineRecord.Service_Days__c != null) 
        { 
      decimal frequencyDivisor =1; 
      List<String> serviceDayList = quoteLineRecord.Service_Days__c.split(';'); 
      Decimal updatedSize = Decimal.valueOf(serviceDayList.size());
      
      If(quoteLineRecord.Frequency_Interval__c !=  null && quoteLineRecord.Frequency_Interval__c != '')
         	frequencyDivisor = decimal.valueOf(quoteLineRecord.Frequency_Interval__c);
           
        if(decimal.valueOf(asset.Weekly_Frequency__c) != (updatedSize/frequencyDivisor).setScale(6))
    {
            frequencyChange = true; }
        else {
            frequencyChange = false;}
        }
        return frequencyChange;
    }
    /* SDT-33285 End */
    
    /* SDT-33285 for checking Equipment Size */
     public static boolean changeInSize(SBQQ__QuoteLine__c quoteLineRecord,Asset asset) { 
      
        Boolean changeInSize = false;
        String assetVolumefinal;
        
        if(quoteLineRecord.AssetId__r.Equipment_Size__c != null && quoteLineRecord.AssetId__r.Equipment_Size__c != 'Unknown' && quoteLineRecord.Equipment_Size__c != null )
        {
        
         Double assetSize = Double.valueOf(quoteLineRecord.AssetId__r.Equipment_Size__c.substringBefore(' '));
         Double quoteLineSize = Double.valueOf(quoteLineRecord.Equipment_Size__c.substringAfter('-'));
         
         String assetVolume = String.valueOf(quoteLineRecord.AssetId__r.Equipment_Size__c.substringAfter(' '));
         String quoteLineVolume = String.valueOf(quoteLineRecord.Equipment_Size__c.substringBefore('-'));
        
          if(assetVolume.Contains('Gallons'))
          {
              assetVolumefinal = 'GALS';
          }
          else if(assetVolume.Contains('Pounds'))
          {
              assetVolumefinal = 'PNDS';
          }
          else if(assetVolume.Contains('Tons'))
          {
              assetVolumefinal = 'TONS';
          }
           else if(assetVolume.Contains('Yards'))
          {
              assetVolumefinal = 'YRDS';
          }
          else if(assetVolume.Contains('Feet'))
          {
              assetVolumefinal = 'FEET';
          }
          else if(assetVolume.Contains('Inches'))
          {
              assetVolumefinal = 'INCS';
          }
          else if(assetVolume.Contains('Unknown'))
          {
              assetVolumefinal = 'UNK';
          }
                
        if(quoteLineSize != assetSize || quoteLineVolume!= assetVolumefinal)
            {
                changeInSize = true;
            }    
        }
        // system.debug(1/0);
        return changeInSize;
    }
    /* SDT-33285 End */
    
     /* SDT-33285 for checking Cost and Price Scenario */
   public static List<Update_Cost_Price_on_Asset_to_Quoteline__mdt> foundCostAndPriceScenario(SBQQ__QuoteLine__c quoteLineRecord,String parentQuoteName,Asset asset, String productFamily) {        
        List<Update_Cost_Price_on_Asset_to_Quoteline__mdt> customMetadataObj = new List<Update_Cost_Price_on_Asset_to_Quoteline__mdt>();
        String getScenarios = callScenarios(quoteLineRecord,asset);
        boolean frequencyChange = frequencyChange(quoteLineRecord,asset);
													 
        
        System.debug('getScenarios>>>'+getScenarios);
														
																																															
											 
																			 
		 
			  
																	
		
													   
        System.debug('quoteLineRecord.Occurrence_Type__c>>>'+quoteLineRecord.Occurrence_Type__c);
        System.debug('getScenarios>>>'+getScenarios);
        System.debug('asset.Occurrence_Type__c>>>'+asset.Occurrence_Type__c);
        
        customMetadataObj = [Select Pricing_Call__c,Expected_Result__c  from Update_Cost_Price_on_Asset_to_Quoteline__mdt 
                             where Occurrence_Type__c = :asset.Occurrence_Type__c and 
                             Product_Family__c = :productFamily and 
                             Updated_Occurrence_Type__c = :quoteLineRecord.Occurrence_Type__c and 
                             Type__c = 'Amendment' and 
                             Final_Frequency__c = :frequencyChange and 
                             Scenarios__c = : getScenarios];
        
                                                                      
																												 
										   
									 
									   
						  
									 
																	 
        return customMetadataObj;
    }

    /*
     * @vendor			 TCS
     * @story		   	 SDT-29385
     * @author			 Seema Dhikale
     * @description       This method is used to set default values for quoteLines. Applicable for all case record types 
     * @param             Quoteline being updated and Parent Quote Name
     * @return            Void     */ 
     public static void setDefaultValuesForQuoteLines(SBQQ__QuoteLine__c quoteLineRecord,String parentQuoteName){
         //Changes for SDT-29104
         quoteLineRecord.SBQQ__ListPrice__c = 0;
         quoteLineRecord.SBQQ__UnitCost__c = null;
         //SDT 32742
         quoteLineRecord.CostMinQuantity__c = null;
         quoteLineRecord.PriceMinQuantity__c= null;
         //adding codition to prevent integration error from Acorn
         if(quoteLineRecord.CostModelType__c=='STP'){
             //changes for SDT-31776
             //whenever(on start date updation) cost and price are getting null/zero mark Stepped cost and price null and zero two
             quoteLineRecord.CostPrice1__c = null;
             quoteLineRecord.CostPrice2__c = null;
             quoteLineRecord.CostPrice3__c = null;
             quoteLineRecord.CostPrice4__c = null;
             //changes for SDT - 32442
             //setting step Upto value null
             quoteLineRecord.CostStep01UpTo__c = null;
             quoteLineRecord.CostStep02UpTo__c = null;
             quoteLineRecord.CostStep03UpTo__c = null;
             quoteLineRecord.CostStep04UpTo__c = null; 
             quoteLineRecord.CostUpTo1__c = null;
             quoteLineRecord.CostUpTo2__c = null;
             quoteLineRecord.CostUpTo3__c = null;
             quoteLineRecord.CostUpTo4__c = null;
         }
         //adding codition to prevent integration error from Acorn
         if(quoteLineRecord.PricingUnitMethod__c=='STP'){
             quoteLineRecord.PricePrice1__c = null;
             quoteLineRecord.PricePrice2__c = null;
             quoteLineRecord.PricePrice3__c = null;
             quoteLineRecord.PricePrice4__c = null;
             quoteLineRecord.PriceUpTo1__c = null;
             quoteLineRecord.PriceUpTo2__c = null;
             quoteLineRecord.PriceUpTo3__c = null;
             quoteLineRecord.PriceUpTo4__c = null;
         }
         }

    
    /* SDT-33285 End */
    /*
* @vendor            TCS
* @story             SDT-29385
* @author            Seema Dhikale
     * @description       This method is used to set default values for quoteLines. Applicable for all case record types 
     * @param             Quoteline being updated and Parent Quote Name
     * @return            Void
     */ 
    
    public static void setDefaultValuesForQuoteLines(SBQQ__QuoteLine__c quoteLineRecord,String parentQuoteName,Asset asset){
        System.debug('>>>>quoteLineRecord.Schedule_Frequency__c>>>'+quoteLineRecord.Schedule_Frequency__c);
        //if(quoteLineRecord.Schedule_Frequency__c == 'Weekly') 
        /* SDT-33285 Start */
        String productFamily ;
        String quoteType ;
        String productName ;
        boolean serviceChange =changeInService(quoteLineRecord,asset);
        if(quoteLineRecord.SBQQ__RequiredBy__c != null){
            
            List<SBQQ__QuoteLine__c> fetchProductFamily =  [Select id,SBQQ__ProductName__c,SBQQ__Quote__r.SBQQ__Type__c,SBQQ__RequiredBy__c,SBQQ__ProductFamily__c from  SBQQ__QuoteLine__c where id  = :quoteLineRecord.SBQQ__RequiredBy__c];
            If(fetchProductFamily.Size() > 0)
                productFamily = fetchProductFamily[0].SBQQ__ProductFamily__c;
            quoteType = fetchProductFamily[0].SBQQ__Quote__r.SBQQ__Type__c;
            productName = fetchProductFamily[0].SBQQ__ProductName__c; //SDT-41643
        }
        else {
            productFamily = quoteLineRecord.SBQQ__ProductFamily__c;}
        String sQuoteLineProductName = quoteLineRecord.SBQQ__ProductName__c;       
        List<Update_Cost_Price_on_Asset_to_Quoteline__mdt> customMetadataObj = foundCostAndPriceScenario(quoteLineRecord,parentQuoteName,asset,productFamily);
        if(quoteType == 'Amendment' && asset != null) /* && !(sQuoteLineProductName == 'Gate Fee' || sQuoteLineProductName == 'Push Out/Pull Out')) // SDT-41643*/
        {
          //  if((quoteLineRecord.Schedule_Frequency__c == 'W' && asset.Frequency__c =='Weekly') ||   (quoteLineRecord.Schedule_Frequency__c == '' || quoteLineRecord.Schedule_Frequency__c == null)) 		    
               if((quoteLineRecord.Schedule_Frequency__c == 'W' && asset.Frequency__c =='Weekly') ||   ((quoteLineRecord.Schedule_Frequency__c == '' || quoteLineRecord.Schedule_Frequency__c == null) 
                && asset.Frequency__c =='Weekly' ) || ((asset.Frequency__c =='' || asset.Frequency__c == null) && quoteLineRecord.Schedule_Frequency__c == 'W'))
            
		{     
                
                System.debug('productFamily>>>'+productFamily);
                
                System.debug('>>>>customMetadataObj>>>'+customMetadataObj);
                if(customMetadataObj.size() > 0)
                {                    
                    if(customMetadataObj[0].Expected_Result__c != '' && customMetadataObj[0].Expected_Result__c != null) {
                        
                        
                        quoteLineRecord.CostMinQuantity__c = null;
                        quoteLineRecord.PriceMinQuantity__c= null;																																   
                        quoteLineRecord.SBQQ__ListPrice__c = null;
                        
                        
                        
                        quoteLineRecord.SBQQ__UnitCost__c = null;
                        
                        
                        quoteLineRecord.CostPrice1__c = null;
                        quoteLineRecord.CostPrice2__c = null;
                        quoteLineRecord.CostPrice3__c = null;
                        quoteLineRecord.CostPrice4__c = null;
                        
                        
                        quoteLineRecord.CostStep01UpTo__c = null;
                        quoteLineRecord.CostStep02UpTo__c = null;
                        quoteLineRecord.CostStep03UpTo__c = null;
                        quoteLineRecord.CostStep04UpTo__c = null; 
                        quoteLineRecord.CostUpTo1__c = null;
                        quoteLineRecord.CostUpTo2__c = null;
                        quoteLineRecord.CostUpTo3__c = null;
                        quoteLineRecord.CostUpTo4__c = null;
                        
                        
                        quoteLineRecord.PricePrice1__c = null;
                        quoteLineRecord.PricePrice2__c = null;
                        quoteLineRecord.PricePrice3__c = null;
                        quoteLineRecord.PricePrice4__c = null;
                        quoteLineRecord.PriceUpTo1__c = null;
                        quoteLineRecord.PriceUpTo2__c = null;
                        quoteLineRecord.PriceUpTo3__c = null;
                        quoteLineRecord.PriceUpTo4__c = null;
                        
                        
                        if(customMetadataObj[0].Pricing_Call__c == false) {
                            quoteLineRecord.ByPassFunctionality__c = 'Update_Price';
                        } 
                    }
                    
                    
                    
                    
                    
                    
                    
                    
                    
                }              
            }
            else/*if(quoteLineRecord.Schedule_Frequency__c != 'W')*/ {
                quoteLineRecord.SBQQ__ListPrice__c = 0;
                quoteLineRecord.SBQQ__UnitCost__c = null;
                quoteLineRecord.CostPrice1__c = null;
                quoteLineRecord.CostPrice2__c = null;
                quoteLineRecord.CostPrice3__c = null;
                quoteLineRecord.CostPrice4__c = null;
                
                
                quoteLineRecord.CostStep01UpTo__c = null;
                quoteLineRecord.CostStep02UpTo__c = null;
                quoteLineRecord.CostStep03UpTo__c = null;
                quoteLineRecord.CostStep04UpTo__c = null; 
                quoteLineRecord.CostUpTo1__c = null;
                quoteLineRecord.CostUpTo2__c = null;
                quoteLineRecord.CostUpTo3__c = null;
                quoteLineRecord.CostUpTo4__c = null;
                
                
                quoteLineRecord.PricePrice1__c = null;
                quoteLineRecord.PricePrice2__c = null;
                quoteLineRecord.PricePrice3__c = null;
                quoteLineRecord.PricePrice4__c = null;
                quoteLineRecord.PriceUpTo1__c = null;
                quoteLineRecord.PriceUpTo2__c = null;
                quoteLineRecord.PriceUpTo3__c = null;
                quoteLineRecord.PriceUpTo4__c = null;
                
            }
        }
        else if(quoteType == 'Correction' || quoteType == 'Exception') {           
            if(customMetadataObj.size() > 0 && customMetadataObj[0].Pricing_Call__c == false)
            {                                   
                quoteLineRecord.ByPassFunctionality__c = 'Update_Price';                
            }                          
        }
        /* SDT-33285 End */
        /* SDT-41643 Start */
        else if(quoteType =='Amendment' && asset != null && (sQuoteLineProductName == 'Gate Fee' || sQuoteLineProductName == 'Push Out/Pull Out') && (serviceChange) && customMetadataObj.size()==0)
        {           
            quoteLineRecord.SBQQ__ListPrice__c = null;
            quoteLineRecord.SBQQ__UnitCost__c = null;
        }
        /* SDT-41643 End */
        
        //Changes for SDT-29104
        // quoteLineRecord.SBQQ__ListPrice__c = 0;
        //  quoteLineRecord.SBQQ__UnitCost__c = null;
        
        
        //SDT 32742
        
        
        
        
    }

    /* SDT-41643 Start  */
    public static boolean changeInService(SBQQ__QuoteLine__c quoteLineRecord,Asset asset) {     
        Boolean changeInService = false;
        Boolean changeInOccurrence = false;
        Boolean ChangeInDays = false;
        
        List<String> quoteOccurrenceList = new List<String> ();
        List<String> assetOccurrenceList = new List<String>();
        
        if(null !=  quoteLineRecord.Occurrence_Type__c  && null != asset.Occurrence_Type__c ) {
            quoteOccurrenceList = quoteLineRecord.Occurrence_Type__c.split(';');
            assetOccurrenceList = asset.Occurrence_Type__c.split(';');      
        }
        
        List<String> quoteScheduleList = new List<String>();
        List<String> assetScheduleList = new List<String> ();
        
        if(null !=  quoteLineRecord.Service_Schedule__c  && null != asset.Schedule__c ) {
            quoteScheduleList.add(quoteLineRecord.Service_Schedule__c);
            assetScheduleList.add(asset.Schedule__c);     
        }
        
        
        List<String> serviceDayList = new List<String>(); 
        
        if(null != quoteLineRecord.Service_Days__c)
            serviceDayList = quoteLineRecord.Service_Days__c.split(';');
        
        System.debug('quoteLineRecord.>>>'+quoteLineRecord);
        System.debug('asset.>>>'+asset);
        
        if((assetOccurrenceList.Contains('Scheduled') && quoteOccurrenceList.Contains('OC')) ||
           (assetOccurrenceList.Contains('On-Call') && quoteOccurrenceList.Contains('SCH')) && 
           (assetScheduleList != quoteScheduleList))
            
        {
            changeInOccurrence = true;
        }
        
        
        boolean frequencyChange = frequencyChange(quoteLineRecord,asset);
        boolean sizeChange = changeInSize(quoteLineRecord,asset);
        String getScenarios = callScenarios(quoteLineRecord,asset);
        
        if(getScenarios == 'Multiple_changes' || 
           getScenarios == 'Occurrence_change' || 
           
           getScenarios == 'Weekday_to_Weekend' ||
           getScenarios == 'Weekday_to_Blank' ||
           
           getScenarios == 'Weekend_to_Weekday' ||
           getScenarios == 'Weekend_to_Weekend' ||
           getScenarios == 'Weekend_to_Blank' ||
           
           getScenarios == 'Blank_to_Weekday' ||
           getScenarios == 'Blank_to_Weekend' ||
           getScenarios == 'Blank_to_Blank'
          )
        {
            ChangeInDays = true;
        }
        else if(getScenarios == 'Weekday_to_Weekday')
        {
            ChangeInDays = false;
        }
        
        
        if(changeInOccurrence || frequencyChange || sizeChange || ChangeInDays ||asset.Quantity__c != quoteLineRecord.SBQQ__Quantity__c ) {
            changeInService = true;
        }
        return changeInService;  
    }
     /* SDT-41643 End  */
     
     
     // SDT-31110 sets the values of specific fields from bundle to newly created child QL on insert
     // for NonNewservice Quotes 
     // Toshender Kumar
     // Called by QuotelineTriggerHandler in before insert
     public static void setQuoteLineValueFromBundle(SBQQ__QuoteLine__c quotelineToUpdate,List<SBQQ__QuoteLine__c> bundleQuotelines, SBQQ__Quote__c quote, Id keysParentId){
         
         // any other record type other than New Service, it should work, Avoid  NewService,
         // Disable Copy if comming from Asset to QL conversion DISABLE_QL_COPY_FROM_BUNDLE_ONINSERT is set high from AssetQuoteProcurementController.createAssetQuoteLines
         // Should not run for Parent Bundle
         if(string.valueOf(quote.SBQQ__Opportunity2__r.Case__r.RecordType.DeveloperName).equalsIgnoreCase(Constant_Util.R_NEW_SERVICE_CASE)
            || DISABLE_QL_COPY_FROM_BUNDLE_ONINSERT || quotelineToUpdate.SBQQ__RequiredBy__c==null
           ){
               return ;
           }
                 
         
         if(!bundleQuotelines.isEmpty()){
             
             Set<string> fieldSet = FieldSetReader.readFieldSet(QuoteLineSelector.Fields_To_Copy_From_Bundle,
                                                                QuoteLineSelector.ObjectName);
             
             //system.debug('bundleQuotelines >'+ bundleQuotelines.size());
             // Setting up index as -1
             Integer selectedBundleIndex=-1;
             // looping over Parent lines
             for(Integer i =0; i < bundleQuotelines.size(); i++)
             {
                 SBQQ__QuoteLine__c bundleLine =bundleQuotelines[i];
 
                //Fetching Parent Record
                // As Child will be at 2 Level: Parent > Child > SubChild.. (Parent > Waste Category > Waste Stream)
                if(bundleLine.Id == quotelineToUpdate.SBQQ__RequiredBy__c || (keysParentId != null  && bundleLine.Id == keysParentId))
                {
                   selectedBundleIndex= i;
                   break;
                }
             }
             
             // If parent index found then assigning values to newly inserted line
             if(selectedBundleIndex >= 0)
             {
                 SBQQ__QuoteLine__c bundleQuoteline = bundleQuotelines[selectedBundleIndex];
                 for(string field : fieldSet){
                     quotelineToUpdate.put(field, bundleQuoteline.get(field));
                 }
             }
         }
         
     }
     //31120
     private static final string US_LOCATION = 'United States';
     private static final string CANADA_LOCATION = 'Canada';
     
     
     /*@methodName- populateEndDateForAdditionalServices
 *@description- Method to set QLs end date
 *@param- Id : SBQQ__QuoteLine__c
 *@return- None
 */ 
     public static void populateEndDateForAdditionalServices(List<SBQQ__QuoteLine__c> quoteLineList) {
         List<SBQQ__QuoteLine__c> quoteLineListToUpdateEndDate = new List<SBQQ__QuoteLine__c>();
         Id businessHoursId = QuoteLineSelector.getBusinessHourId();
         
         If(quoteLineList!=null){
             for(SBQQ__QuoteLine__c quoteLine : quoteLineList){
                 if(quoteLine.SBQQ__Product__c!=null && quoteLine.SBQQ__Product__r.EndDateOffset__c!=null && quoteLine.Account__c!=null && (quoteLine.Account__r.ShippingCountry==US_LOCATION || quoteLine.Account__r.ShippingCountry==CANADA_LOCATION) && quoteLine.SBQQ__StartDate__c!=null){
                     quoteLineListToUpdateEndDate.add(populateEndDateForQuoteline(quoteLine,businessHoursId));
                 }
         }
     }
     }
     
     /*@methodName- populateEndDateForQuoteline
 *@description- Method to set QLs end date
 *@param- Id : SBQQ__QuoteLine__c
 *@return- None
 */ 
     public static SBQQ__QuoteLine__c populateEndDateForQuoteline(SBQQ__QuoteLine__c quoteLine,Id businessHoursId) {
         List<string> dayOffsetOptions = quoteLine.SBQQ__Product__r.EndDateOffset__c.split(';');
         map<string,string> locationDaysOffsetMap = new map<string,string>();
         for(string s : dayOffsetOptions){
             locationDaysOffsetMap.put(s.substringBefore('_'),s.substringAfter('_'));
         }
         
         Date calculatedEndDate = quoteLine.SBQQ__EndDate__c;
         Integer businessDays=0;
         if(!locationDaysOffsetMap.isEmpty()){
             if(quoteLine.Account__r.ShippingCountry==US_LOCATION && locationDaysOffsetMap.keyset().contains(quoteLine.Account__r.ShippingCountry)){
                 string daysOption = locationDaysOffsetMap.get(quoteLine.Account__r.ShippingCountry);
                 if(daysOption!='None'){
                     businessDays=Integer.valueOf(daysOption);
                     date startdate=quoteLine.SBQQ__StartDate__c;
                     Datetime startDatetime = datetime.newInstance(startdate, Time.newInstance(12,0,0,0));
                     Datetime enddate=startDatetime.addDays(businessDays);
                     while(!BusinessHours.isWithin( businessHoursId, enddate)){
                         enddate = enddate.addDays(1);
                     }
                     calculatedEndDate=Date.valueOf(enddate);
                     }
             }else if(quoteLine.Account__r.ShippingCountry==CANADA_LOCATION && locationDaysOffsetMap.keyset().contains(quoteLine.Account__r.ShippingCountry)){
                 string daysOption = locationDaysOffsetMap.get(quoteLine.Account__r.ShippingCountry);
                 if(daysOption!='None'){
                     businessDays=Integer.valueOf(daysOption);
                     date startdate=quoteLine.SBQQ__StartDate__c;
                     Datetime startDatetime = datetime.newInstance(startdate, Time.newInstance(12,0,0,0));
                     Datetime enddate=startDatetime.addDays(businessDays);
                     while(!BusinessHours.isWithin( businessHoursId, enddate)){
                         enddate = enddate.addDays(1);
                     }
                     calculatedEndDate=Date.valueOf(enddate);
                     }  
             }
             // Changes for SDT-32092 & SDT-32089
             if(quoteLine.SBQQ__EndDate__c==null && calculatedEndDate != null){
                 quoteLine.SBQQ__EndDate__c = calculatedEndDate;
                 update quoteLine;
             }else{
                //Changes related to SDT-38985 - added a check if case recordtype = New Service
                if(quoteLine.SBQQ__EndDate__c < calculatedEndDate && quoteLine.SBQQ__Quote__r.Case_record_Type__c != Constant_Util.New_Service_Case && 
                   (quoteLine.SBQQ__RequiredBy__r.SBQQ__EndDate__c == null) //TCS-pkulkarn-SDT-41377-Added check for SBQQ__RequiredBy__r.SBQQ__EndDate__c
                  )
                {
                    quoteLine.SBQQ__EndDate__c = calculatedEndDate;
                    update quoteLine;
                }
             }
         }
         return quoteLine;
     } 
     //SDT-32124
     public static boolean isQuoteLineChangedforNonNs(SBQQ__QuoteLine__c quoteline){
         return
         (quoteline.SBQQ__Quote__r.Case_record_Type__c.equalsIgnoreCase(Constant_Util.New_Service_Case) ||
          quoteline.IsAssetQuotelineDifferent__c || quoteline.AssetId__c == null);
     }
 /* @vendor            TCS
 * @story             SDT-33136
 * @author            Seema Dhikale
 * @description       This method is used to set SBQQ__UnitCost__c and SBQQ__ListPrice__c to 0 when asset is not tagged to Quoteline for quoteLines. 
 * @param             Quoteline being updated 
 */ 
     public static void setListUnitCostToZero(SBQQ__QuoteLine__c ql){
         if(ql.SBQQ__ProductName__c==Constant_Util.KEYS && ql.AssetId__c==null){
                 ql.SBQQ__UnitCost__c=0;
                 ql.SBQQ__ListPrice__c=0;             
             }
     }
    
     
     public static void updateQuantityForLockProducts(SBQQ__QuoteLine__c quoteLine, Decimal bundleQuantity)
     {
         // Created By: TCS, pkulkarn
         // CreatedDate: 05-DEC-23
         // Story: SDT-33379
         // Comment: To update Quantity for Lock Fee and Lock products when quantity is changed on Bundle.
         // Input/Output: quoteLine, quantity/quoteLine
 
         String lockFeeAndLockProductsLabel = '';
         try
         {
             lockFeeAndLockProductsLabel = System.Label.LockFeeAndLockProducts;
             if(lockFeeAndLockProductsLabel == null || String.isEmpty(lockFeeAndLockProductsLabel) || String.isBlank(lockFeeAndLockProductsLabel))
                 return;
             if(lockFeeAndLockProductsLabel.contains(quoteLine.SBQQ__ProductName__c))
                 quoteLine.SBQQ__Quantity__c = bundleQuantity;
         }
         catch(Exception e)
         {
             return;
         }
     }
 
   // Created By: Seema Dhikale
    // CreatedDate: 21-Feb-24
    // Story: SDT-30079
    // Comment: added if to check numberof days value- entered by user is from 1 to 500
    //It will work only from intake screen
    //field reffered here is---Frequency_Interval__c fromQuoteline object
    public static String checkForMaxValueWhileSchedulingDays(String frequency)
    {
        Schema.sObjectField schemaScheduleFrequency = SBQQ__QuoteLine__c.Frequency_Interval__c.getDescribe().getSObjectField();//UtilityApexClass
        Map<Object,List<String>> frequencyIntervalForScheduleFrequencyDailyMap = UTIL_Picklist.getDependentPicklistValues(schemaScheduleFrequency);
        List<String> frequencyIntervalForScheduleFrequencyDailyList=new list<String>();
        // get the values of Frequency_Interval__c
        if(frequencyIntervalForScheduleFrequencyDailyMap.containsKey(SCHEDULE_FREQUENCY_DAILY)){
            for(String dailyFreqIntervalActiveValues : frequencyIntervalForScheduleFrequencyDailyMap.get(SCHEDULE_FREQUENCY_DAILY)){
                frequencyIntervalForScheduleFrequencyDailyList.add(dailyFreqIntervalActiveValues);
            }
        }
        String maxDailyFrequencyInterval ='';
        maxDailyFrequencyInterval = frequencyIntervalForScheduleFrequencyDailyList.get(frequencyIntervalForScheduleFrequencyDailyList.size()-1);
        string msg = '';
        if(frequency==null || !frequencyIntervalForScheduleFrequencyDailyList.contains(frequency)){
			msg = String.format(MAX_EVERYDAY_SCHEDULE,new List<object>{maxDailyFrequencyInterval});            
        }
        return msg;
    }
    
    // Created By: Seema Dhikale
    // CreatedDate: 11-03-24
    // Story: SDT-31262
    // Comment: added if to check numberof weeks value- entered by user is from 1 to 30
    //It will work only from intake screen
    //dependent field reffered here is---Frequency_Interval__c fromQuoteline object
    //controlling field reffered here is---Schedule_Frequency__c(weekly) fromQuoteline object
    public static String checkForMaxValueWhileSchedulingWeeks(String frequency)
    {
        Schema.sObjectField schemaScheduleFrequency = SBQQ__QuoteLine__c.Frequency_Interval__c.getDescribe().getSObjectField();//UtilityApexClass
        Map<Object,List<String>> frequencyIntervalForScheduleFrequencyWeeklyMap = UTIL_Picklist.getDependentPicklistValues(schemaScheduleFrequency);
        List<String> frequencyIntervalForScheduleFrequencyWeeklyList=new list<String>();
        // get the values of Frequency_Interval__c
        if(frequencyIntervalForScheduleFrequencyWeeklyMap.containsKey(SCHEDULE_FREQUENCY_WEEKLY)){
            for(String weeklyFreqIntervalActiveValues : frequencyIntervalForScheduleFrequencyWeeklyMap.get(SCHEDULE_FREQUENCY_WEEKLY)){
                frequencyIntervalForScheduleFrequencyWeeklyList.add(weeklyFreqIntervalActiveValues);
            }
        }
        String maxWeeklyFrequencyInterval ='';
        maxWeeklyFrequencyInterval = frequencyIntervalForScheduleFrequencyWeeklyList.get(frequencyIntervalForScheduleFrequencyWeeklyList.size()-1);
        string msg = '';
        if(frequency==null || !frequencyIntervalForScheduleFrequencyWeeklyList.contains(frequency)){
			msg = String.format(MAX_EVERYWEEK_SCHEDULE,new List<object>{maxWeeklyFrequencyInterval});            
        }
        return msg;
    }

    //TCS-pkulkarn-SDT-38495-20-May-2024-Added to validate the Frequency Interval field for the Schedule Frequency of Monthly
    public static String checkForMaxValueWhileSchedulingMonthly(String frequencyInterval)
    {
        Schema.sObjectField schemaScheduleFrequency = SBQQ__QuoteLine__c.Frequency_Interval__c.getDescribe().getSObjectField();
        Map<Object,List<String>> frequencyIntervalForScheduleFrequencyMonthlyMap = UTIL_Picklist.getDependentPicklistValues(schemaScheduleFrequency);
        List<String> frequencyIntervalForScheduleFrequencyMonthlyList=new list<String>();
        // get the values of Frequency_Interval__c
        if(frequencyIntervalForScheduleFrequencyMonthlyMap.containsKey(SCHEDULE_FREQUENCY_MONTHLY)){
            for(String monthlyFreqIntervalActiveValues : frequencyIntervalForScheduleFrequencyMonthlyMap.get(SCHEDULE_FREQUENCY_MONTHLY)){
                frequencyIntervalForScheduleFrequencyMonthlyList.add(monthlyFreqIntervalActiveValues);
            }
        }
        String maxMonthlyFrequencyInterval = '';
        maxMonthlyFrequencyInterval = frequencyIntervalForScheduleFrequencyMonthlyList.get(frequencyIntervalForScheduleFrequencyMonthlyList.size()-1);
        string msg = '';
        if(frequencyInterval==null || !frequencyIntervalForScheduleFrequencyMonthlyList.contains(frequencyInterval)){
            msg = String.format(MAX_EVERYMONTH_SCHEDULE,new List<object>{maxMonthlyFrequencyInterval});            
        }
        return msg;
    }
    //SDT 41407
    //method to generate hover over for monthly schedule
	public static String generateMonthlyScheduleDetails(SBQQ__QuoteLine__c ql)
    {
        string monthlyScheduleDetails='';
        String startDate = '';
        if(ql!=null && ql.Schedule_Frequency__c!=null && ql.Schedule_Frequency__c=='M'){
            if(ql.Day_of_Month__c!=null){
                String details = 'Occurs on day {0} of every {1} month(s)';
                if(ql.SBQQ__StartDate__c!=null){
                    startDate = String.valueof(date.valueof(ql.SBQQ__StartDate__c));
                    details = 'Occurs on day {0} of every {1} month(s) effective {2}';
                }
                monthlyScheduleDetails = String.format(details,new List<object>{ql.Day_of_Month__c,ql.Frequency_Interval__c,startDate});
            }
            else if(ql.Month_Relative_Interval__c!=null && ql.Month_Relative__c!=null){
                String details = 'Occurs on {0} {1} of every {2} month(s)';
                if(ql.SBQQ__StartDate__c!=null){
                    startDate = String.valueof(date.valueof(ql.SBQQ__StartDate__c));
                    details = 'Occurs on {0} {1} of every {2} month(s) effective {3}';
                }
                monthlyScheduleDetails = String.format(details,new List<object>{ql.Month_Relative_Interval__c,ql.Month_Relative__c,ql.Frequency_Interval__c,startDate});
            }
        }
        return monthlyScheduleDetails;
    }
}
