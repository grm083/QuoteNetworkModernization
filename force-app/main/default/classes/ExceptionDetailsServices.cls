/*
    * @Name          ExceptionDetailsServices
    * @Author        Seema Dhikale
    * @Vendor        TCS
    * @Date          15/01/2024
    * @description   This class will be used as Service class for Exception Details fields, story SDT-34351
    * 				 As of now Exception Details fields includes Exception Date, Exception Type, Exception Reason, Exception Comments
    */
public with sharing class ExceptionDetailsServices {
    //defaults for quote Lines
    static final String EXCEPTION_TYPE_Client_INITIATED_CHANGE = 'CLTINITCHG';
    static final String EXCEPTION_TYPE_OAKLEAF_INITIATED_CHANGE = 'OAKINITCHG';
    static final String EXCEPTION_REASON_NEW_SERVICE = 'NEWSRV';
    static final String EXCEPTION_REASON_SERVICE_CHANGE = 'SERCHG';
    static final String EXCEPTION_REASON_DATA_ERROR_FIX = 'DERRFIX';
    static final String USER_CATEGORIZATION_CODE = 'SFCOR';
    static final String ExceptionComment = 'This spec was generated by Salesforce Quote Number: {0}, created under Case: {1} Ref#: {2}';
    
    
    /*
	* @vendor            TCS
	* @story             SDT-34351
	* @author            Seema Dhikale
	* @description       This method is used to set Exception details for given quoteLine. 
	* @param             Quoteline being updated
	* @return            NA
	*/ 
    public static void setExceptionDetails(SBQQ__QuoteLine__c quoteLineRecord,SBQQ__QuoteLine__c parentQuoteLine,boolean changeExpReasonFlag,boolean isPrevStartDateAndExceptionEffectiveDateSame){
        List<SBQQ__QuoteLine__c> qlListToUpdateExceptionDetails=new List<SBQQ__QuoteLine__c>();
        if(quoteLineRecord.Exception_Type__c==null || quoteLineRecord.Exception_Reason__c==null){
            //system.debug('quoteLineRecord Exception_Type__c'+quoteLineRecord.Name+'parentQuoteLine'+parentQuoteLine.name);
            setExceptionTypeAndReason( quoteLineRecord, parentQuoteLine,changeExpReasonFlag);
        }
        if(quoteLineRecord.Exception_Comments__c==null){
            //system.debug('quoteLineRecord Exception_comment__c'+quoteLineRecord.Name+'parentQuoteLine'+parentQuoteLine.name);
            setExceptionComment( quoteLineRecord, parentQuoteLine);
        }
        if(quoteLineRecord.Exceptions_Effective_Date__c==null  || isPrevStartDateAndExceptionEffectiveDateSame){
         //if((quoteLineRecord.Exceptions_Effective_Date__c==quoteLineRecord.SBQQ__StartDate__c && quoteLineRecord.Vendor_Commit_Date__c!=quoteLineRecord.Exceptions_Effective_Date__c) || quoteLineRecord.Exceptions_Effective_Date__c==null){
            //system.debug('quoteLineRecord Exception_date__c'+quoteLineRecord.Name+'parentQuoteLine'+parentQuoteLine.name);
            setExceptionDate( quoteLineRecord, parentQuoteLine);
        }
    }
    
    /*
	* @vendor            TCS
	* @story             SDT-34351
	* @author            Seema Dhikale
	* @description       This method is used to set Exception_Reason__c and Exception_Type__c for quoteLines. 
	* @param             Quoteline being updated,
						 changeExceptionReasonFlag--it is always false for New Service cases
												  --for rest of case record types including modify existing it denotes atleast one quoteline(having asset id) is getting changed.
	* @return            NA
	*/ 
    public static void setExceptionTypeAndReason(SBQQ__QuoteLine__c quoteLineRecord,SBQQ__QuoteLine__c parentQuoteLine,boolean changeExceptionReasonFlag){
        boolean isInternalCorrectionsTeamUser=UserServices.isInternalCorrectionTeamUser(UserInfo.getUserId());
                
        if(changeExceptionReasonFlag==true && isInternalCorrectionsTeamUser==true){
            quoteLineRecord.Exception_Type__c = EXCEPTION_TYPE_OAKLEAF_INITIATED_CHANGE;
            quoteLineRecord.Exception_Reason__c = EXCEPTION_REASON_DATA_ERROR_FIX;
        }
        else if(changeExceptionReasonFlag==true && quoteLineRecord.Exception_Reason__c != Constant_Util.EXCEPTION_REASON_SERVICE_CHANGE && !isInternalCorrectionsTeamUser){
            quoteLineRecord.Exception_Type__c = EXCEPTION_TYPE_CLIENT_INITIATED_CHANGE;
            quoteLineRecord.Exception_Reason__c = EXCEPTION_REASON_SERVICE_CHANGE;
        }
        else if(!changeExceptionReasonFlag && !isInternalCorrectionsTeamUser){
            quoteLineRecord.Exception_Type__c = EXCEPTION_TYPE_CLIENT_INITIATED_CHANGE;
            quoteLineRecord.Exception_Reason__c = EXCEPTION_REASON_NEW_SERVICE;
        }
        else if(!changeExceptionReasonFlag && isInternalCorrectionsTeamUser== true){
        	quoteLineRecord.Exception_Type__c = EXCEPTION_TYPE_OAKLEAF_INITIATED_CHANGE;
        	quoteLineRecord.Exception_Reason__c = EXCEPTION_REASON_DATA_ERROR_FIX;     
        }
    }
    /*
* @vendor            TCS
* @story             SDT-34351 /SDT 32803
* @author            Seema Dhikale
* @description       This method is used to set Exception_Reason__c for quoteLines. 
* @param             Quoteline being updated and changeExceptionReasonFlag
* @return            changeExceptionReasonFlag boolean value
*/ 
    public static boolean setExceptionReason(SBQQ__QuoteLine__c ql,boolean changeExceptionReasonFlag){
        //boolean isInternalCorrectionsTeamUser=false;
        boolean isInternalCorrectionsTeamUser=UserServices.isInternalCorrectionTeamUser(UserInfo.getUserId());
        if(ql.Exception_Type__c==null || ql.Exception_Reason__c==null){
            if(isInternalCorrectionsTeamUser){
            ql.Exception_Type__c = EXCEPTION_TYPE_OAKLEAF_INITIATED_CHANGE;
            ql.Exception_Reason__c = EXCEPTION_REASON_DATA_ERROR_FIX;
        }
        if(!isInternalCorrectionsTeamUser){
            ql.Exception_Type__c = EXCEPTION_TYPE_CLIENT_INITIATED_CHANGE;
            ql.Exception_Reason__c = EXCEPTION_REASON_SERVICE_CHANGE;}
        
        changeExceptionReasonFlag=true;
        }
        return changeExceptionReasonFlag;
    }
    
    /*
	* @vendor            TCS
	* @story             SDT-34351
	* @author            Seema Dhikale
	* @description       This method is used to set Exception_Comments__c for quoteLines. 
	* @param             to be updated Quoteline with respect to Exception_Comments__c
	* @return            NA
	*/ 
    public static void setExceptionComment(SBQQ__QuoteLine__c quoteLineRecord,SBQQ__QuoteLine__c parentQuoteLine){
        if( quoteLineRecord != null && parentQuoteLine != null ){
            String parentQuoteName = parentQuoteLine.SBQQ__Quote__r.Name;
            String parentQuoteCaseNumber = parentQuoteLine.SBQQ__Quote__r.Case_Number__c;
            String parentQuoteCaseRefNumber = parentQuoteLine.SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.Reference_Number__c;
            quoteLineRecord.Exception_Comments__c = String.format(ExceptionComment,new List<object>{parentQuoteName,parentQuoteCaseNumber,parentQuoteCaseRefNumber});
        }else if(quoteLineRecord != null && quoteLineRecord.SBQQ__RequiredBy__c == null)
        {
            //quoteLineRecord.SBQQ__RequiredBy__c == null this will be true for bundle quoteline
            String parentQuoteName = quoteLineRecord.SBQQ__Quote__r.Name;
            String parentQuoteCaseNumber = quoteLineRecord.SBQQ__Quote__r.Case_Number__c;
            String parentQuoteCaseRefNumber = quoteLineRecord.SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.Reference_Number__c;
            quoteLineRecord.Exception_Comments__c = String.format(ExceptionComment,new List<object>{parentQuoteName,parentQuoteCaseNumber,parentQuoteCaseRefNumber});
        }else if(quoteLineRecord != null && quoteLineRecord.SBQQ__RequiredBy__c != null && quoteLineRecord.SBQQ__RequiredBy__r.SBQQ__RequiredBy__c != null)
        {
            //quoteLineRecord.SBQQ__RequiredBy__r.SBQQ__RequiredBy__c gives grand parent relation
            String parentQuoteName = quoteLineRecord.SBQQ__RequiredBy__r.SBQQ__RequiredBy__r.SBQQ__Quote__r.Name;
            String parentQuoteCaseNumber = quoteLineRecord.SBQQ__RequiredBy__r.SBQQ__RequiredBy__r.SBQQ__Quote__r.Case_Number__c;
            String parentQuoteCaseRefNumber = quoteLineRecord.SBQQ__RequiredBy__r.SBQQ__RequiredBy__r.SBQQ__Quote__r.SBQQ__Opportunity2__r.Case__r.Reference_Number__c;
            quoteLineRecord.Exception_Comments__c = String.format(ExceptionComment,new List<object>{parentQuoteName,parentQuoteCaseNumber,parentQuoteCaseRefNumber});
        }
    }
    
    
    
    /*
	* @vendor            TCS
	* @story             SDT-34351
	* @author            Seema Dhikale
	* @description       This method is used to set Exception_Effective_Date__c/Exceptions_Effective_Date__c for quoteLines. 
	* @param             to be updated Quoteline with respect to Exception_Effective_Date__c/Exceptions_Effective_Date__c
	* @return            NA
	*/ 
    public static void setExceptionDate(SBQQ__QuoteLine__c quoteLineRecord,SBQQ__QuoteLine__c parentQuoteLine){
        //if(parentQuoteLine.Vendor_Commit_Date__c==quoteLineRecord.SBQQ__StartDate__c){
         	quoteLineRecord.Exceptions_Effective_Date__c = quoteLineRecord.SBQQ__StartDate__c;
            //quoteLineRecord.Exception_Effective_Date__c = DateTime.newInstanceGMT(quoteLineRecord.SBQQ__StartDate__c.year(), quoteLineRecord.SBQQ__StartDate__c.month(), quoteLineRecord.SBQQ__StartDate__c.day(),12,00,00);
        //}
    }
    
     /*
	* @vendor            TCS
	* @story             SDT-34351
	* @author            Seema Dhikale
	* @description       This method is used to set Exception_Effective_Date__c/Exceptions_Effective_Date__c for quoteLines. 
	* @param             to be updated Quoteline with respect to Exception_Effective_Date__c/Exceptions_Effective_Date__c
	* @return            NA
	*/ 
    public static void setExceptionDate(SBQQ__QuoteLine__c quoteLineRecord){
        quoteLineRecord.Exceptions_Effective_Date__c = quoteLineRecord.SBQQ__StartDate__c;
    }
    
     /*
	* @vendor            TCS
	* @story             SDT-32952
	* @author            Seema Dhikale
	* @description       This method is used to set Exception_Effective_Date__c/Exceptions_Effective_Date__c for removal quoteLine 
	* @Asumption         start date/Exceptions_Effective_Date__c of removal Quoteline will always be enddate of Quoteline. 
	* @return            NA
	*/ 
    public static void setRemovalQLExceptionDate(SBQQ__QuoteLine__c removalQL,Date endDate){
         if(endDate!=null){
         	removalQL.Exception_Effective_Date__c = DateTime.newInstanceGMT(endDate.year(), endDate.month(), endDate.day(),12,00,00);
       	    removalQL.Exceptions_Effective_Date__c = endDate;
        }
    }
    
    /*
	* @vendor            TCS
	* @story             SDT-38011
	* @author            Seema Dhikale
	* @description       This method is used to copy Exceptions_Effective_Date__c to Exceptions_Effective_Date__c for quoteLine 
	* @called from       Before insert and before update of quoteline. 
	* @return            NA
	*/ 
    public static void copyExceptionEffectiveDateToExceptionsEffectiveDate(List<SBQQ__QuoteLine__c > quoteLineNewList){
         if(quoteLineNewList!=null){
            for(SBQQ__QuoteLine__c ql : quoteLineNewList)
            {
                if(ql.Exceptions_Effective_Date__c!=null && ql.Exception_Effective_Date__c!=ql.Exceptions_Effective_Date__c){
                    ql.Exception_Effective_Date__c = ql.Exceptions_Effective_Date__c;
                }
            }
        }
    }
    

}